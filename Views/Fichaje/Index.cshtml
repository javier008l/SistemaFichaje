@model SistemaFichaje.Models.FichajeViewModel

@{
    ViewData["Title"] = "Control Horario";
}

<div class="text-center mt-5">
    <h2>‚è±Ô∏è Control de Jornada</h2>
    <p class="text-muted">Registro oficial de horario</p>

    <!-- ESTADO ACTUAL -->
    <div class="card my-4 shadow-sm">
        <div class="card-body">
            <h3>Estado Actual:
                @if (Model.UltimoEstado == null || Model.UltimoEstado == SistemaFichaje.Models.TipoFichaje.Salida)
                {
                    <span class="badge bg-secondary">FUERA DE JORNADA üî¥</span>
                }
                else if (Model.UltimoEstado == SistemaFichaje.Models.TipoFichaje.Entrada || Model.UltimoEstado ==
                SistemaFichaje.Models.TipoFichaje.FinPausa)
                {
                    <span class="badge bg-success">TRABAJANDO üü¢</span>
                }
                else
                {
                    <span class="badge bg-warning text-dark">EN PAUSA ‚òï</span>
                }
            </h3>
        </div>
    </div>

    <!-- BOTONES DE ACCI√ìN (Formulario) -->
    <form asp-action="Fichar" method="post" id="formFichaje">
        <!-- Campos ocultos para geolocalizaci√≥n -->
        <input type="hidden" name="latitud" id="lat" />
        <input type="hidden" name="longitud" id="lon" />

        <div class="d-grid gap-2 col-6 mx-auto">

            @* LOGICA VISUAL: Solo mostramos los botones l√≥gicos *@

            @if (Model.UltimoEstado == null || Model.UltimoEstado == SistemaFichaje.Models.TipoFichaje.Salida)
            {
                <button type="submit" name="tipo" value="1" class="btn btn-success btn-lg p-4" onclick="pedirGeo()">
                    üöÄ ENTRADA JORNADA
                </button>
            }

            @if (Model.UltimoEstado == SistemaFichaje.Models.TipoFichaje.Entrada || Model.UltimoEstado ==
                        SistemaFichaje.Models.TipoFichaje.FinPausa)
            {
                <button type="submit" name="tipo" value="3" class="btn btn-warning btn-lg mb-2" onclick="pedirGeo()">
                    ‚òï INICIAR PAUSA
                </button>
                <button type="submit" name="tipo" value="2" class="btn btn-danger btn-lg" onclick="pedirGeo()">
                    üèÅ FIN DE JORNADA
                </button>
            }

            @if (Model.UltimoEstado == SistemaFichaje.Models.TipoFichaje.InicioPausa)
            {
                <button type="submit" name="tipo" value="4" class="btn btn-primary btn-lg p-4" onclick="pedirGeo()">
                    üîô VOLVER DE PAUSA
                </button>
            }
        </div>
    </form>
</div>

<!-- TABLA DE HISTORIAL HOY -->
<div class="mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>üìÖ Historial de Registros</h4>

        <!-- BOT√ìN DE DESCARGA -->
        <a asp-action="DescargarReporte" class="btn btn-outline-primary">
            üì• Descargar Excel (CSV)
        </a>
    </div>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Hora</th>
                <th>Acci√≥n</th>
                <th>Ubicaci√≥n</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.HistorialHoy)
            {
                <tr>
                    <!-- Convertimos UTC a hora local del navegador -->
                    <td>@item.FechaHora.ToLocalTime().ToString("HH:mm:ss")</td>
                    <td>@item.Tipo</td>
                    <td>
                        @if (item.Geolocalizacion != "No permitida" && !string.IsNullOrEmpty(item.Geolocalizacion))
                        {
                            <a href="https://www.google.com/maps/search/?api=1&query=@item.Geolocalizacion" target="_blank"
                                class="btn btn-sm btn-outline-info">
                                üìç Ver Mapa
                            </a>
                            <!-- Opcional: mostrar coords peque√±as abajo -->
                            <br>

                            <small class="text-muted">@item.Geolocalizacion</small>
                        }
                        else
                        {
                            <span class="text-muted">üö´ Sin ubicaci√≥n</span>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- SCRIPT DE GEOLOCALIZACI√ìN -->
<script>
    function pedirGeo() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                // √âxito: Guardamos coords
                function (position) {
                    document.getElementById('lat').value = position.coords.latitude;
                    document.getElementById('lon').value = position.coords.longitude;
                },
                // Error: Avisamos (opcional)
                function (error) {
                    console.warn("‚ö†Ô∏è No se pudo obtener ubicaci√≥n:", error.message);
                    alert("Activa la ubicaci√≥n para fichar correctamente");
                }
            );
        } else {
            console.error("‚ùå Geolocalizaci√≥n no soportada por este navegador.");
        }
    }

    // Pedimos al cargar la p√°gina
    document.addEventListener("DOMContentLoaded", function () {
        pedirGeo();
    });

    // Y TAMBI√âN pedimos al hacer clic en cualquier bot√≥n del formulario (Doble seguridad)
    document.getElementById("formFichaje").addEventListener("submit", function () {
        // Intentamos una √∫ltima actualizaci√≥n r√°pida antes de enviar, 
        // aunque el submit suele ser m√°s r√°pido que el GPS, 
        // esto asegura que si ya tenemos coords cacheadas, se env√≠en.
        pedirGeo();
    });
</script>