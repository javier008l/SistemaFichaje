@model SistemaFichaje.Models.FichajeViewModel

@{
    ViewData["Title"] = "Control Horario";
}

<div class="text-center mt-5">
    <h2>‚è±Ô∏è Control de Jornada</h2>
    <p class="text-muted">Registro oficial de horario</p>

    <!-- ESTADO ACTUAL -->
    <div class="card my-4 shadow-sm">
        <div class="card-body">
            <h3>Estado Actual:
                @if (Model.UltimoEstado == null || Model.UltimoEstado == SistemaFichaje.Models.TipoFichaje.Salida)
                {
                    <span class="badge bg-secondary">FUERA DE JORNADA üî¥</span>
                }
                else if (Model.UltimoEstado == SistemaFichaje.Models.TipoFichaje.Entrada || Model.UltimoEstado == SistemaFichaje.Models.TipoFichaje.FinPausa)
                {
                    <span class="badge bg-success">TRABAJANDO üü¢</span>
                }
                else
                {
                    <span class="badge bg-warning text-dark">EN PAUSA ‚òï</span>
                }
            </h3>
        </div>
    </div>

    <!-- BOTONES DE ACCI√ìN (Formulario) -->
    <form asp-action="Fichar" method="post" id="formFichaje">
        <!-- Campos ocultos para geolocalizaci√≥n -->
        <input type="hidden" name="latitud" id="lat" />
        <input type="hidden" name="longitud" id="lon" />

        <div class="d-grid gap-2 col-6 mx-auto">

            @* LOGICA VISUAL: Solo mostramos los botones l√≥gicos *@

            @if (Model.UltimoEstado == null || Model.UltimoEstado == SistemaFichaje.Models.TipoFichaje.Salida)
            {
                <button type="submit" name="tipo" value="1" class="btn btn-success btn-lg p-4" onclick="pedirGeo()">
                    üöÄ ENTRADA JORNADA
                </button>
            }

            @if (Model.UltimoEstado == SistemaFichaje.Models.TipoFichaje.Entrada || Model.UltimoEstado == SistemaFichaje.Models.TipoFichaje.FinPausa)
            {
                <button type="submit" name="tipo" value="3" class="btn btn-warning btn-lg mb-2" onclick="pedirGeo()">
                    ‚òï INICIAR PAUSA
                </button>
                <button type="submit" name="tipo" value="2" class="btn btn-danger btn-lg" onclick="pedirGeo()">
                    üèÅ FIN DE JORNADA
                </button>
            }

            @if (Model.UltimoEstado == SistemaFichaje.Models.TipoFichaje.InicioPausa)
            {
                <button type="submit" name="tipo" value="4" class="btn btn-primary btn-lg p-4" onclick="pedirGeo()">
                    üîô VOLVER DE PAUSA
                </button>
            }
        </div>
    </form>
</div>

<!-- FILTROS Y DESCARGA -->
<div class="card card-body bg-light mb-4 mt-5">
    <form asp-action="Index" method="get" class="row g-3 align-items-end">
        <div class="col-auto">
            <label class="form-label">Desde:</label>
            <input type="date" name="fechaInicio" class="form-control" 
                   value="@Model.FechaInicio?.ToString("yyyy-MM-dd")" />
        </div>
        <div class="col-auto">
            <label class="form-label">Hasta:</label>
            <input type="date" name="fechaFin" class="form-control" 
                   value="@Model.FechaFin?.ToString("yyyy-MM-dd")" />
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-primary">üîç Filtrar</button>
            <a asp-action="Index" class="btn btn-outline-secondary">‚ùå Limpiar</a>
        </div>
        
        <!-- Bot√≥n de Descarga alineado a la derecha -->
        <div class="col ms-auto text-end">
             <a asp-action="DescargarReporte" class="btn btn-success">
                üì• Descargar Excel
            </a>
        </div>
    </form>
</div>

<h4>üìÖ Historial de Registros</h4>

<!-- TABLA DE RESULTADOS -->
@if (Model.HistorialHoy != null && Model.HistorialHoy.Any())
{
    <div class="table-responsive">
        <table class="table table-striped table-hover mt-3 align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Fecha y Hora</th>
                    <th>Acci√≥n</th>
                    <th>Ubicaci√≥n</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.HistorialHoy)
                {
                    <tr>
                        <td>@item.FechaHora.ToLocalTime().ToString("dd/MM/yyyy HH:mm:ss")</td>
                        <td>
                            @if (item.Tipo == SistemaFichaje.Models.TipoFichaje.Entrada)
                            {
                                <span class="badge bg-success">ENTRADA</span>
                            }
                            else if (item.Tipo == SistemaFichaje.Models.TipoFichaje.Salida)
                            {
                                <span class="badge bg-danger">SALIDA</span>
                            }
                            else if (item.Tipo == SistemaFichaje.Models.TipoFichaje.InicioPausa)
                            {
                                <span class="badge bg-warning text-dark">INICIO PAUSA</span>
                            }
                            else
                            {
                                <span class="badge bg-info text-dark">FIN PAUSA</span>
                            }
                        </td>
                        <td>
                             @if (!string.IsNullOrEmpty(item.Geolocalizacion) && item.Geolocalizacion.Contains(","))
                            {
                                <a href="https://www.google.com/maps/search/?api=1&query=@item.Geolocalizacion" 
                                   target="_blank" 
                                   class="btn btn-sm btn-outline-primary"
                                   title="Ver en Google Maps">
                                    üìç Ver Mapa
                                </a>
                                <small class="text-muted ms-2" style="font-size: 0.8em;">(@item.Geolocalizacion)</small>
                            }
                            else
                            {
                                <span class="text-muted fst-italic">@item.Geolocalizacion</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <div class="alert alert-warning mt-3" role="alert">
        üì≠ No se encontraron registros para este rango de fechas.
    </div>
}

<!-- SCRIPT DE GEOLOCALIZACI√ìN -->
<script>
    function pedirGeo() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                // √âxito: Guardamos coords
                function (position) {
                    document.getElementById('lat').value = position.coords.latitude;
                    document.getElementById('lon').value = position.coords.longitude;
                },
                // Error: Avisamos (opcional)
                function (error) {
                    console.warn("‚ö†Ô∏è No se pudo obtener ubicaci√≥n:", error.message);
                    // alert("Activa la ubicaci√≥n para fichar correctamente"); 
                }
            );
        } else {
            console.error("‚ùå Geolocalizaci√≥n no soportada por este navegador.");
        }
    }

    // Pedimos al cargar la p√°gina
    document.addEventListener("DOMContentLoaded", function () {
        pedirGeo();
    });

    // Y TAMBI√âN pedimos al hacer clic en cualquier bot√≥n del formulario (Doble seguridad)
    document.getElementById("formFichaje").addEventListener("submit", function () {
        pedirGeo();
    });
</script>
